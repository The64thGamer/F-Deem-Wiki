<article>
	{{ if .Params.description }}
		<h1>{{ .Params.description }}</h1>
	{{ end }}

	{{ if .Params.pageThumbnailFile }}
	<div class="instruction-thumbnail">
		<img src="/photos/{{ .Params.pageThumbnailFile }}" alt="{{ .Title }}">
	</div>
	{{ else }}
		<img src="/photos/File Not Found.jpg" alt="{{ .Title }}">
	{{ end }}

	{{ if and (.Params.imageSetName) (ge .Params.imageSetAmount 1) }}
		<div class="instruction-pages">
		{{ $base := .Params.imageSetName }}
		{{ $amount := .Params.imageSetAmount }}
		{{ $allPieces := dict }}

		{{ range seq 0 (sub $amount 1) }}
		{{ $pageNum := . }}
		{{ $pageKey := printf "page%dPieces" $pageNum }}
		{{ $pieces := index $.Params $pageKey }}

		{{ if and (eq $pageNum 0) (not (eq (len $allPieces) 0)) }}
			<!-- Overview Page 0 -->
			<div class="instruction-page">
			<div class="page-number">Page 0</div>
			<div class="piece-box">
				{{ range $key, $val := $allPieces }}
				{{ $parts := split $key "|" }}
				{{ $name := index $parts 0 }}
				{{ $color := index $parts 1 }}
				{{ $count := $val }}
				<a href="/pieces/{{ $name | urlize }}">
					<div class="piece-entry" style="border-color: {{ $color | lower }}">
					<img class="desaturated" src="/photos/{{ $name | urlize }}.avif" alt="{{ $name }}">
					<div class="piece-count">{{ $count }}x</div>
					</div>
				</a>
				{{ end }}
			</div>
			</div>
		{{ else }}
			<div class="instruction-page">
			<div class="page-number">Page {{ add $pageNum 1 }}</div>
			{{ $imgPath := printf "/photos/%s%d.avif" $base $pageNum }}
			<img src="{{ $imgPath }}" alt="{{ $.Title }}">

			{{ if $pieces }}
				<div class="piece-box">
				{{ range $piece := $pieces }}
					{{ $split := split $piece "|" }}
					{{ $name := index $split 0 }}
					{{ $color := index $split 1 }}
					{{ $count := index $split 2 }}
					{{ $key := printf "%s|%s" $name $color }}
					{{ $existing := index $allPieces $key }}
					{{ $newCount := add (default 0 $existing) (int $count) }}
					{{ $_ := merge $allPieces (dict $key $newCount) }}

					<a href="/pieces/{{ $name | urlize }}">
					<div class="piece-entry" style="border-color: {{ $color | lower }}">
						<img class="desaturated" src="/photos/{{ $name | urlize }}.avif" alt="{{ $name }}">
						<div class="piece-count">{{ $count }}x</div>
					</div>
					</a>
				{{ end }}
				</div>
			{{ end }}
			</div>
		{{ end }}
		{{ end }}

		</div>
	{{ end }}

	<div>
		{{ .Content }}
	</div>
</article>
