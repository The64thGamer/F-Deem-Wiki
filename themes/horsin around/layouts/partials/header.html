{{- $tagCategories := dict
"Sizes" (slice "1x1" "1x2" "1x3" "1x4" "1x5" "1x6" "1x7" "1x8" "1x10" "1x12" "1x16" "2x2" "2x3" "2x4" "2x6" "2x8" "2x10"
"2x12" "2x16" "3x2" "4x4" "4x6" "4x8" "8x8" "8x12" "16x16")
"Types" (slice "Brick" "Plate" "Storage" "Accessory" "Figure" "Char" "Item" "Discontinued")
"Shapes" (slice "Rounded" "Ramp" "Cliff" "Debossed" "Out Peg" "In Peg")
"Themes" (slice "Construction" "Food" "The Scary")
}}

{{- $site := .Site.RegularPages -}}
<div class="navbar-scroll-container">
  <button class="scroll-btn left" onclick="scrollNavbar(-200)" id="scroll-left">❮</button>

  <ul class="navbar-menu scrollable" id="scrollable-navbar">
    <li class="navbar-item dropdown"><a href="https://f-deem.org/" class="navbar-brand">Forum</a></li>
    <li class="navbar-item dropdown"><a href="/categories/sets" class="navbar-brand">Sets</a></li>
    <li class="navbar-item dropdown"><a href="/categories/piece" class="navbar-brand">All Pieces</a></li>

    {{ range $categoryName, $tags := $tagCategories }}
    <li class="navbar-item dropdown" data-dropdown="{{ $categoryName | urlize }}">
      <a href="#" class="dropdown-toggle">{{ $categoryName }}</a>
    </li>
    {{ end }}
  </ul>

  <button class="scroll-btn right" onclick="scrollNavbar(200)" id="scroll-right">❯</button>
</div>

<!-- Render dropdowns outside the scrollable menu -->
<div class="dropdown-container">
  {{ range $categoryName, $tags := $tagCategories }}
  <ul class="dropdown-menu" id="dropdown-{{ $categoryName | urlize }}">
    {{ range $tags }}
    {{ $tag := . }}
    {{ $count := 0 }}
    {{ range $site }}
    {{ if in .Params.tags $tag }}
    {{ $count = add $count 1 }}
    {{ end }}
    {{ end }}
    {{ $tagFix := $tag | replaceRE "[ &,-]" "-" | urlize }}
    <li>
      <a href="{{ "tags/" | relLangURL }}{{ $tagFix }}" title="All pages with tag {{ $tag }}">
        {{ $tag }}<sup>({{ $count }})</sup>
      </a>
    </li>
    {{ end }}
  </ul>
  {{ end }}
</div>

<script>
  const navbar = document.getElementById('scrollable-navbar');
  const leftBtn = document.getElementById('scroll-left');
  const rightBtn = document.getElementById('scroll-right');
  const dropdowns = document.querySelectorAll('.navbar-item.dropdown');

  function scrollNavbar(amount) {
    navbar.scrollBy({ left: amount, behavior: 'smooth' });
  }

  function updateScrollButtons() {
    const scrollLeft = Math.ceil(navbar.scrollLeft);
    const scrollWidth = navbar.scrollWidth;
    const clientWidth = navbar.clientWidth;

    const atStart = scrollLeft <= 0;
    const atEnd = scrollLeft >= scrollWidth - clientWidth - 1;

    leftBtn.style.display = atStart ? 'none' : 'inline-block';
    rightBtn.style.display = atEnd ? 'none' : 'inline-block';
  }

  navbar.addEventListener('scroll', updateScrollButtons);
  window.addEventListener('resize', updateScrollButtons);
  window.addEventListener('DOMContentLoaded', updateScrollButtons);

  // Position dropdowns on hover
  dropdowns.forEach(item => {
    const id = item.getAttribute('data-dropdown');
    const menu = document.getElementById(`dropdown-${id}`);

    item.addEventListener('mouseenter', () => {
      const rect = item.getBoundingClientRect();
      menu.style.display = 'block';
      menu.style.position = 'absolute';
      menu.style.top = rect.bottom + 'px';
      menu.style.left = rect.left + 'px';
    });

    item.addEventListener('mouseleave', () => {
      setTimeout(() => menu.style.display = 'none', 200);
    });

    menu.addEventListener('mouseenter', () => {
      menu.style.display = 'block';
    });
    menu.addEventListener('mouseleave', () => {
      menu.style.display = 'none';
    });
  });
</script>
